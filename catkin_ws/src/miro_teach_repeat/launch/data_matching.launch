<launch>
	<!-- Global params -->
	<rosparam param="miro_data_load_dir">~/miro/data/office2</rosparam>
	<rosparam param="miro_data_save_dir">~/miro/data/office2_tests/5</rosparam>
	<rosparam param="image_resize_width">115</rosparam>
	<rosparam param="image_resize_height">44</rosparam>
	<rosparam param="image_subsampling">1</rosparam>
	<rosparam param="wait_for_ready">true</rosparam>
	<rosparam param="patch_size">(9,9)</rosparam>
	<rosparam param="calibration_file_left" subst_value="True">$(find miro_teach_repeat)/calibration/left_360.yaml</rosparam>
	<rosparam param="calibration_file_right" subst_value="True">$(find miro_teach_repeat)/calibration/right_360.yaml</rosparam>

	<group ns="miro">
		<!-- Hold head in place, reset odometry and disable cliff sensors -->
		<node pkg="miro_teach_repeat" type="miro_setup.py" name="miro_setup" launch-prefix="bash -c 'sleep 5; $0 $@' " output="screen">
			<rosparam param="lift">30</rosparam>
			<rosparam param="yaw">0</rosparam>
			<rosparam param="pitch">8</rosparam>
			<rosparam param="reset_odom">true</rosparam>
			<rosparam param="disable_cliff_sensors">true</rosparam>
		</node>

		<!-- Load image files for matching -->
		<node pkg="miro_teach_repeat" type="image_matcher.py" name="image_matcher" output="screen" >
			<rosparam param="use_old_dataset_format">false</rosparam>
			<rosparam param="use_depth">false</rosparam>
			<rosparam param="use_middle_weighting">false</rosparam>
		</node>

		<!-- Stitch image files for matching -->
		<node pkg="miro_teach_repeat" type="image_stitcher.py" name="image_stitcher" output="screen" />

		<!-- Follow the previous poses using odometry, but use images to correct for odometry drift -->
		<node pkg="miro_teach_repeat" type="localiser.py" name="localiser" output="screen" >
			<remap from="odom" to="sensors/odom/integrated" />
			<remap from="image" to="sensors/cam/both" />
			<rosparam param="stop_at_end">true</rosparam>
			<rosparam param="discrete-correction">false</rosparam>
		</node>

		<!-- Drive to goal pose -->
		<node pkg="miro_teach_repeat" type="drive_to_pose_controller.py" name="drive_to_pose" output="screen" >
			<remap from="cmd_vel" to="control/cmd_vel" />
			<remap from="odom" to="sensors/odom/integrated" />
		</node>

		<!-- Show image matching -->
		<node pkg="image_view" type="image_view" name="image_match_debug_view" >
			<remap from="image" to="match_image_debug" />
		</node>
	</group>
</launch>